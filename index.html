<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro Pessoal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --cor-fundo: #f0f2f5; --cor-texto: #363f5f; --cor-texto-leve: #969cb3; --cor-card: #ffffff;
            --cor-borda: #e2e8f0; --cor-verde: #10b981; --cor-vermelho: #ef4444; --cor-azul: #3b82f6;
            --cor-amarelo-fundo: #fef9c3; --cor-amarelo-texto: #a16207;
            --sombra-card: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --transicao: all 0.3s ease-in-out;
        }
        body.dark-mode {
            --cor-fundo: #1a202c; --cor-texto: #e2e8f0; --cor-texto-leve: #a0aec0; --cor-card: #2d3748;
            --cor-borda: #4a5568; --cor-amarelo-fundo: #4a4a28; --cor-amarelo-texto: #fef08a;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto); margin: 0; padding: 20px; transition: var(--transicao); }
        .container { max-width: 1600px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 25px; flex-wrap: wrap; gap: 20px; border-bottom: 1px solid var(--cor-borda); margin-bottom: 25px; }
        .header-title { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        header h1 { margin: 0; font-size: 2em; }
        .header-actions { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .grupo-botoes-export { display: flex; align-items: center; gap: 5px; background-color: var(--cor-fundo); padding: 5px; border-radius: 20px; border: 1px solid var(--cor-borda); }
        .btn { padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transicao); font-weight: 500; border: none; cursor: pointer; }
        .btn:hover { filter: brightness(1.1); }
        .btn-verde { background-color: var(--cor-verde); color: white; }
        .btn-vermelho { background-color: var(--cor-vermelho); color: white; }
        .btn-azul { background-color: var(--cor-azul); color: white; }
        .btn-icon { background: none; border: none; font-size: 1.2em; cursor: pointer; color: var(--cor-texto-leve); transition: var(--transicao); display: flex; align-items: center; justify-content: center; width: 38px; height: 38px; border-radius: 50%; }
        .btn-icon:hover { color: var(--cor-texto); background-color: var(--cor-fundo); }
        .grupo-botoes-export .btn-icon { width: 32px; height: 32px; font-size: 1em; }
        .cards-resumo { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; margin-bottom: 25px; }
        .card { background-color: var(--cor-card); padding: 25px; border-radius: 12px; box-shadow: var(--sombra-card); border: 1px solid var(--cor-borda); transition: var(--transicao); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .card.clicavel { cursor: pointer; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: var(--cor-texto-leve); font-weight: 500; }
        .card-header i { font-size: 2em; }
        .card .valor { font-size: 2.2em; font-weight: 600; margin: 0;}
        .card.receitas { border-left: 5px solid var(--cor-verde); } .card.receitas .valor, .card.receitas i { color: var(--cor-verde); }
        .card.despesas { border-left: 5px solid var(--cor-vermelho); } .card.despesas .valor, .card.despesas i { color: var(--cor-vermelho); }
        .card.saldo { border-left: 5px solid var(--cor-azul); } .card.saldo .valor, .card.saldo i { color: var(--cor-azul); }
        .grid-principal { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        .widget { background-color: var(--cor-card); padding: 25px; border-radius: 12px; box-shadow: var(--sombra-card); border: 1px solid var(--cor-borda); position: relative; }
        .widget h2 { margin-top: 0; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .chart-container { position: relative; width: 100%; height: 400px; }
        .secao-filtros { background-color: var(--cor-card); padding: 20px; border-radius: 12px; box-shadow: var(--sombra-card); margin-bottom: 25px; display: flex; flex-wrap: wrap; gap: 20px; align-items: center; justify-content: space-between; }
        .grupo-filtro { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .grupo-filtro label { font-weight: 500; }
        .grupo-filtro input[type="date"], .grupo-filtro select { padding: 8px; border-radius: 6px; border: 1px solid var(--cor-borda); background-color: var(--cor-fundo); color: var(--cor-texto); }
        .btn-filtro { background-color: var(--cor-fundo); border: 1px solid var(--cor-borda); padding: 8px 18px; border-radius: 20px; cursor: pointer; transition: var(--transicao); font-weight: 500; }
        .btn-filtro.active { background-color: var(--cor-azul); color: white; border-color: var(--cor-azul); }
        .tabela-contas-wrapper { max-height: 400px; overflow-y: auto; }
        .tabela-contas { width: 100%; border-collapse: collapse; }
        .tabela-contas th, .tabela-contas td { text-align: left; padding: 14px; border-bottom: 1px solid var(--cor-borda); }
        .tabela-contas th:last-child, .tabela-contas td:last-child { text-align: right; }
        .tabela-contas thead { position: sticky; top: 0; background-color: var(--cor-card); z-index: 1; }
        .tabela-contas tbody tr:hover { background-color: var(--cor-fundo); }
        .tabela-contas .status-Pendente { background-color: var(--cor-amarelo-fundo); color: var(--cor-amarelo-texto); font-weight: 500; }
        .tabela-contas .acoes { display: flex; gap: 10px; justify-content: flex-end; }
        .modal-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeIn 0.3s ease; padding: 15px; box-sizing: border-box; }
        .modal-content { background-color: var(--cor-card); padding: 30px; border-radius: 12px; width: 100%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: scaleUp 0.3s ease; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--cor-borda); }
        .modal-header h2 { margin: 0; }
        .modal-body { overflow-y: auto; padding-right: 15px; margin-right: -15px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-content form { display: flex; flex-direction: column; gap: 15px; }
        .form-grupo { display: flex; flex-direction: column; gap: 5px; }
        .form-grupo label { font-weight: 500; font-size: 0.9em; color: var(--cor-texto-leve); }
        .modal-content input, .modal-content select, .modal-content textarea { padding: 12px; border: 1px solid var(--cor-borda); border-radius: 8px; font-size: 1em; background-color: var(--cor-fundo); color: var(--cor-texto); transition: var(--transicao); font-family: 'Poppins', sans-serif; }
        .form-botoes { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease-out; min-width: 250px; }
        .toast.success { background-color: var(--cor-verde); }
        .toast.error { background-color: var(--cor-vermelho); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .loading-container, .empty-state { display: flex; justify-content: center; align-items: center; min-height: 200px; text-align: center; color: var(--cor-texto-leve); font-size: 1.2em; }
        .empty-state { display: none; }
        @media (max-width: 1200px) { .grid-principal { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            body { padding: 10px; }
            header { flex-direction: column; align-items: flex-start; }
            header h1 { font-size: 1.6em; }
            .header-actions { width: 100%; justify-content: space-between; }
            .grupo-botoes-registro { gap: 10px; }
            .grupo-botoes-registro .btn { padding: 10px 15px; }
            .secao-filtros { flex-direction: column; align-items: stretch; gap: 15px; }
            .grupo-filtro { justify-content: center; }
            #filtro-personalizado { flex-direction: column; align-items: stretch; }
            .chart-container { height: 300px; }
            .tabela-contas thead { display: none; }
            .tabela-contas tr { display: block; border: 1px solid var(--cor-borda); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
            .tabela-contas td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border: none; text-align: right; }
            .tabela-contas td::before { content: attr(data-label); font-weight: bold; text-align: left; color: var(--cor-texto); margin-right: 10px; }
            .tabela-contas td.acoes { justify-content: flex-end; padding-top: 10px; }
            .tabela-contas td.acoes::before { display: none; }
        }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div id="app-container">
        <!-- TELA DE LOGIN/CADASTRO -->
        <div id="auth-container" class="modal-container" style="display: flex; position: static; animation: none;">
            <div class="modal-content" style="max-width: 450px;">
                <div class="modal-header"><h2 id="auth-title">Entrar</h2></div>
                <div class="modal-body">
                    <form id="form-login" style="display: block;">
                        <div class="form-grupo"><label for="login-email">Email</label><input type="email" id="login-email" required autocomplete="email"></div>
                        <div class="form-grupo"><label for="login-password">Senha</label><input type="password" id="login-password" required autocomplete="current-password"></div>
                        <div class="form-botoes" style="flex-direction: column; gap: 15px; align-items: stretch;">
                            <button type="submit" class="btn btn-azul">Entrar</button>
                            <button type="button" id="toggle-to-signup" class="btn" style="background-color: transparent; border: 1px solid var(--cor-borda);">Não tem uma conta? Cadastre-se</button>
                        </div>
                    </form>
                    <form id="form-signup" style="display: none;">
                        <div class="form-grupo"><label for="signup-email">Email</label><input type="email" id="signup-email" required autocomplete="email"></div>
                        <div class="form-grupo"><label for="signup-password">Senha (mínimo 6 caracteres)</label><input type="password" id="signup-password" required autocomplete="new-password"></div>
                        <div class="form-botoes" style="flex-direction: column; gap: 15px; align-items: stretch;">
                            <button type="submit" class="btn btn-azul">Cadastrar</button>
                            <button type="button" id="toggle-to-login" class="btn" style="background-color: transparent; border: 1px solid var(--cor-borda);">Já tem uma conta? Entre</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- DASHBOARD (Oculto por padrão) -->
        <div id="dashboard-container" class="container" style="display: none;">
             <header>
                <div class="header-title">
                    <h1>Dashboard</h1>
                    <button class="btn-icon" id="btn-refresh" title="Recarregar Dados"><i class="fa-solid fa-sync-alt"></i></button>
                </div>
                <div class="header-actions">
                    <button class="btn btn-azul" id="btn-analise-ia" title="Obter análise financeira com IA"><i class="fa-solid fa-wand-magic-sparkles"></i> Análise com IA</button>
                    <button class="btn-icon" id="btn-toggle-theme" title="Mudar tema"><i class="fa-solid fa-moon"></i></button>
                    <div class="grupo-botoes-registro">
                        <button id="btn-abrir-modal-receita" class="btn btn-verde"><i class="fa-solid fa-plus"></i> Receita</button>
                        <button id="btn-abrir-modal-despesa" class="btn btn-vermelho"><i class="fa-solid fa-minus"></i> Despesa</button>
                    </div>
                    <button class="btn" id="btn-logout" style="background-color: var(--cor-texto-leve); color: var(--cor-card);"><i class="fa-solid fa-right-from-bracket"></i> Sair</button>
                </div>
            </header>
            <main id="main-content">
                <!-- Conteúdo do dashboard será injetado aqui pelo JS -->
            </main>
        </div>
    </div>

    <!-- Modais -->
    <div id="modal-analise-ia" class="modal-container">
        <div class="modal-content"><div class="modal-header"><h2>Análise Financeira (IA)</h2><button id="btn-fechar-analise-ia" class="btn-icon">&times;</button></div><div id="conteudo-analise-ia" class="modal-body"></div></div>
    </div>
    <div id="modal-detalhes" class="modal-container">
        <div class="modal-content"><div class="modal-header"><h2 id="modal-detalhes-titulo">Detalhes</h2><button id="btn-fechar-detalhes" class="btn-icon">&times;</button></div><div id="modal-detalhes-conteudo" class="modal-body"></div></div>
    </div>
    <div id="modal-registro" class="modal-container">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-registro-titulo">Registrar</h2><button id="btn-fechar-registro" class="btn-icon">&times;</button></div>
            <div class="modal-body">
                <form id="form-registro" novalidate>
                    <input type="hidden" id="reg-id"><input type="hidden" id="reg-tipo">
                    <div class="form-grupo"><label for="reg-data">Data</label><input type="date" id="reg-data" required></div>
                    <div class="form-grupo"><label for="reg-local">Local</label><input type="text" id="reg-local" list="datalist-locais" placeholder="Selecione ou digite" required></div>
                    <div class="form-grupo"><label for="reg-fonte">Fonte</label><input type="text" id="reg-fonte" list="datalist-fontes" placeholder="Selecione ou digite" required></div>
                    <div class="form-grupo"><label for="reg-valor">Valor (R$)</label><input type="text" inputmode="decimal" id="reg-valor" placeholder="150,50" required></div>
                    <div class="form-grupo" id="grupo-status"><label for="reg-status">Status</label><select id="reg-status"><option value="Pago">Pago</option><option value="Pendente">Pendente</option></select></div>
                    <div class="form-botoes"><button type="button" class="btn" id="btn-cancelar-registro" style="background-color: #ccc;">Cancelar</button><button type="submit" class="btn" id="btn-salvar-registro"><span class="btn-text">Salvar</span><i class="fa-solid fa-spinner fa-spin" style="display: none;"></i></button></div>
                </form>
            </div>
        </div>
    </div>
    <datalist id="datalist-locais"></datalist>
    <datalist id="datalist-fontes"></datalist>
    
<script>
document.addEventListener('DOMContentLoaded', function() {
    'use strict';
    
    // --- CONFIGURAÇÕES ---
    const SUPABASE_URL = 'https://qldxyvyrafiiqfgxytab.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsZHh5dnlyYWZpaXFmZ3h5dGFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NTc2MzksImV4cCI6MjA3MTUzMzYzOX0.x6rFKRkfJjgkBLVA8tc5FESxM0KwzrkQRG-8qox0HqM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const GEMINI_API_KEY = "AIzaSyC8EQiwXEM6i8vN961zNIXOaqZszVbT-Rk";

    // --- SELETORES GERAIS ---
    const authContainer = document.getElementById('auth-container');
    const dashboardContainer = document.getElementById('dashboard-container');
    
    // --- LÓGICA DE AUTENTICAÇÃO ---
    const formLogin = document.getElementById('form-login');
    const formSignup = document.getElementById('form-signup');
    document.getElementById('toggle-to-signup').addEventListener('click', () => { formLogin.style.display = 'none'; formSignup.style.display = 'block'; document.getElementById('auth-title').textContent = 'Cadastre-se'; });
    document.getElementById('toggle-to-login').addEventListener('click', () => { formSignup.style.display = 'none'; formLogin.style.display = 'block'; document.getElementById('auth-title').textContent = 'Entrar'; });

    formLogin.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) showToast(`Erro no login: ${error.message}`, 'error');
    });

    formSignup.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const { error } = await supabase.auth.signUp({ email, password });
        if (error) {
            showToast(`Erro no cadastro: ${error.message}`, 'error');
        } else {
            showToast('Cadastro realizado! Verifique seu email para confirmar a conta.', 'success');
        }
    });
    
    document.getElementById('btn-logout').addEventListener('click', () => supabase.auth.signOut());

    // --- CONTROLE DE SESSÃO ---
    supabase.auth.onAuthStateChange((event, session) => {
        if (session) {
            authContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';
            iniciarDashboard(session.user);
        } else {
            authContainer.style.display = 'flex';
            dashboardContainer.style.display = 'none';
        }
    });

    // --- FUNÇÃO PRINCIPAL DO DASHBOARD ---
    function iniciarDashboard(user) {
        const mainContent = document.getElementById('main-content');
        mainContent.innerHTML = `
            <section class="cards-resumo">
                <div class="card receitas clicavel" id="card-receitas"><div class="card-header"><span>Receitas</span><i class="fa-solid fa-circle-arrow-up"></i></div><p class="valor" id="total-receitas">R$ 0,00</p></div>
                <div class="card despesas clicavel" id="card-despesas"><div class="card-header"><span>Despesas</span><i class="fa-solid fa-circle-arrow-down"></i></div><p class="valor" id="total-despesas">R$ 0,00</p></div>
                <div class="card saldo clicavel" id="card-saldo"><div class="card-header"><span>Saldo</span><i class="fa-solid fa-scale-balanced"></i></div><p class="valor" id="saldo-total">R$ 0,00</p></div>
            </section>
            <section class="secao-filtros">
                <div class="grupo-filtro" id="filtro-tipo"><button class="btn-filtro active" data-tipo="Todos">Todos</button><button class="btn-filtro" data-tipo="Receita">Receitas</button><button class="btn-filtro" data-tipo="Despesa">Despesas</button></div>
                <div class="grupo-filtro" id="filtro-periodo"><button class="btn-filtro" data-periodo="Diario">Hoje</button><button class="btn-filtro" data-periodo="Semanal">Semana</button><button class="btn-filtro active" data-periodo="Mensal">Mês</button><button class="btn-filtro" data-periodo="Anual">Ano</button></div>
                <div class="grupo-filtro" id="filtro-personalizado"><label for="data-inicio">De:</label><input type="date" id="data-inicio"><label for="data-fim">Até:</label><input type="date" id="data-fim"><button id="btn-aplicar-filtro-data" class="btn-filtro">Aplicar</button></div>
            </section>
            <div id="loading" class="loading-container"><p><i class="fa-solid fa-spinner fa-spin"></i> Carregando dados...</p></div>
            <div id="dashboard-content" style="display:none;">
                <section class="grid-principal">
                    <div class="widget"><h2 id="titulo-grafico">Evolução Financeira</h2><div class="chart-container" id="grafico-linhas-container"><canvas id="grafico-linhas"></canvas></div><div id="grafico-linhas-vazio" class="empty-state"><p><i class="fa-solid fa-chart-line"></i><br>Sem dados.</p></div></div>
                    <div class="widget"><h2 id="titulo-categorias">Top Despesas</h2><div class="chart-container" id="grafico-categorias-container"><canvas id="grafico-categorias"></canvas></div><div id="grafico-categorias-vazio" class="empty-state"><p><i class="fa-solid fa-chart-pie"></i><br>Nenhuma despesa.</p></div></div>
                    <div class="widget" style="grid-column: 1 / -1;"><h2>Planejador de Contas</h2><div class="tabela-contas-wrapper"><table class="tabela-contas"><thead><tr><th>Vencimento</th><th>Fonte</th><th>Valor</th><th>Ações</th></tr></thead><tbody id="corpo-tabela-planejador"></tbody></table></div><div id="planejador-vazio" class="empty-state"><p><i class="fa-solid fa-calendar-check"></i><br>Nenhuma conta pendente.</p></div></div>
                </section>
            </div>`;
            
        // --- DADOS E VARIÁVEIS DO DASHBOARD ---
        const locais = ["Casa"];
        const fontesReceita = ["Gesso", "Lustre", "Outra"];
        const fontesDespesa = ["Água", "Energia", "Lanche", "Roupas", "Compras Mercado", "Combustível", "Materiais de Gesso", "Cartão Lurdes", "Viagem", "Emprestimo", "ECC", "Outra"];
        let transacoesGeral = [];
        let transacoesFiltradas = [];
        let graficoLinhas = null;
        let graficoCategorias = null;
        
        // --- SELETORES DE ELEMENTOS DO DASHBOARD ---
        const loadingDiv = document.getElementById('loading');
        const dashboardContentDiv = document.getElementById('dashboard-content');
        const corpoTabelaPlanejador = document.getElementById('corpo-tabela-planejador');

        // --- FUNÇÕES AUXILIARES ---
        const formatarMoeda = (valor) => (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const formatarData = (data) => data instanceof Date && !isNaN(data) ? data.toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'Data inválida';
        const popularDatalist = (datalistEl, lista) => { datalistEl.innerHTML = ''; lista.sort().forEach(item => { const option = document.createElement('option'); option.value = item; datalistEl.appendChild(option); }); };
        function formatarInputMoeda(inputEl) { let v = inputEl.value.replace(/\D/g, ''); v = (parseInt(v, 10) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 }); if (v === 'NaN') v = ''; inputEl.value = v; }

        // --- FUNÇÕES DE DADOS (SUPABASE) ---
        async function carregarDadosIniciais() {
            loadingDiv.style.display = 'flex';
            dashboardContentDiv.style.display = 'none';
            document.getElementById('btn-refresh').firstElementChild.classList.add('fa-spin');
            try {
                const { data, error } = await supabase.from('transacoes').select('*').eq('user_id', user.id);
                if (error) throw error;
                transacoesGeral = data.map(item => ({ ...item, Data: new Date(`${item.data}T00:00:00`) })).filter(t => t.Data instanceof Date && !isNaN(t.Data));
                aplicarFiltros();
            } catch (error) {
                showToast(`Falha ao carregar: ${error.message}`, 'error');
            } finally {
                loadingDiv.style.display = 'none';
                dashboardContentDiv.style.display = 'block';
                document.getElementById('btn-refresh').firstElementChild.classList.remove('fa-spin');
            }
        }

        async function submeterDados(dados, id = null) {
            const btnSalvar = document.getElementById('btn-salvar-registro');
            btnSalvar.disabled = true;
            const dadosParaSalvar = { ...dados, user_id: user.id };
            try {
                const { error } = id ? await supabase.from('transacoes').update(dadosParaSalvar).eq('id', id) : await supabase.from('transacoes').insert([dadosParaSalvar]);
                if (error) throw error;
                showToast(`Transação ${id ? 'atualizada' : 'registrada'}!`);
                document.getElementById('modal-registro').style.display = 'none';
                carregarDadosIniciais();
            } catch (error) {
                showToast(`Erro ao salvar: ${error.message}`, 'error');
            } finally {
                btnSalvar.disabled = false;
            }
        }

        async function excluirTransacao(id) {
            try {
                const { error } = await supabase.from('transacoes').delete().eq('id', id);
                if (error) throw error;
                showToast('Transação excluída!');
                carregarDadosIniciais();
            } catch (error) {
                showToast(`Erro ao excluir: ${error.message}`, 'error');
            }
        }
        
        // --- RENDERIZAÇÃO E LÓGICA DO DASHBOARD ---
        function aplicarFiltros() {
            const tipo = document.querySelector('#filtro-tipo .active').dataset.tipo;
            const periodoBtn = document.querySelector('#filtro-periodo .active');
            const inicio = document.getElementById('data-inicio').value;
            const fim = document.getElementById('data-fim').value;
            
            transacoesFiltradas = transacoesGeral.filter(t => {
                if (tipo !== 'Todos' && t.tipo !== tipo) return false;
                if (inicio && fim) {
                    return t.Data >= new Date(`${inicio}T00:00:00`) && t.Data <= new Date(`${fim}T23:59:59`);
                }
                if (periodoBtn) {
                    const hoje = new Date();
                    switch (periodoBtn.dataset.periodo) {
                        case 'Diario': return dateFns.isSameDay(t.Data, hoje);
                        case 'Semanal': return dateFns.isThisWeek(t.Data, { weekStartsOn: 1 });
                        case 'Mensal': return dateFns.isSameMonth(t.Data, hoje);
                        case 'Anual': return dateFns.isSameYear(t.Data, hoje);
                    }
                }
                return true;
            });
            atualizarDashboard(transacoesFiltradas.filter(t => t.status !== 'Pendente'));
            renderizarPlanejador(transacoesGeral.filter(t => t.status === 'Pendente'));
        }

        function atualizarDashboard(transacoes) {
            const receitas = transacoes.filter(t => t.tipo === 'Receita').reduce((sum, t) => sum + t.valor, 0);
            const despesas = transacoes.filter(t => t.tipo === 'Despesa').reduce((sum, t) => sum + t.valor, 0);
            document.getElementById('total-receitas').textContent = formatarMoeda(receitas);
            document.getElementById('total-despesas').textContent = formatarMoeda(despesas);
            document.getElementById('saldo-total').textContent = formatarMoeda(receitas - despesas);
            criarGraficoLinhas(transacoes);
            criarGraficoCategorias(transacoes);
        }

        function renderizarPlanejador(itens) {
            corpoTabelaPlanejador.innerHTML = '';
            document.getElementById('planejador-vazio').style.display = itens.length === 0 ? 'flex' : 'none';
            itens.sort((a,b) => a.Data - b.Data).forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'status-Pendente';
                tr.innerHTML = `<td data-label="Vencimento">${formatarData(item.Data)}</td><td data-label="Fonte">${item.fonte}</td><td data-label="Valor">${formatarMoeda(item.valor)}</td><td class="acoes"><button class="btn-icon btn-marcar-pago" data-id="${item.id}" title="Marcar Pago"><i class="fa-solid fa-check"></i></button><button class="btn-icon btn-edit" data-id="${item.id}" title="Editar"><i class="fa-solid fa-pencil"></i></button><button class="btn-icon btn-delete" data-id="${item.id}" title="Excluir"><i class="fa-solid fa-trash"></i></button></td>`;
                corpoTabelaPlanejador.appendChild(tr);
            });
        }
        
        function criarGraficoLinhas(transacoes) {
             const container = document.getElementById('grafico-linhas-container');
             const emptyState = document.getElementById('grafico-linhas-vazio');
             if (graficoLinhas) graficoLinhas.destroy();
             if (transacoes.length === 0) { container.style.display = 'none'; emptyState.style.display = 'flex'; return; }
             container.style.display = 'block'; emptyState.style.display = 'none';
             const ctx = document.getElementById('grafico-linhas').getContext('2d');
             const dadosAgrupados = transacoes.reduce((acc, t) => {
                 const chave = dateFns.startOfDay(t.Data).toISOString();
                 if (!acc[chave]) acc[chave] = { receitas: 0, despesas: 0 };
                 if (t.tipo === 'Receita') acc[chave].receitas += t.valor; else acc[chave].despesas += t.valor;
                 return acc;
             }, {});
             const labels = Object.keys(dadosAgrupados).sort((a, b) => new Date(a) - new Date(b));
             graficoLinhas = new Chart(ctx, { type: 'line', data: { labels, datasets: [ { label: 'Receitas', data: labels.map(k => dadosAgrupados[k].receitas), borderColor: 'var(--cor-verde)', tension: 0.3 }, { label: 'Despesas', data: labels.map(k => dadosAgrupados[k].despesas), borderColor: 'var(--cor-vermelho)', tension: 0.3 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'dd/MM/yyyy' } }, y: { ticks: { callback: v => formatarMoeda(v) } } } } });
        }
        
        function criarGraficoCategorias(transacoes) {
             const container = document.getElementById('grafico-categorias-container');
             const emptyState = document.getElementById('grafico-categorias-vazio');
             if (graficoCategorias) graficoCategorias.destroy();
             const despesas = transacoes.filter(t => t.tipo === 'Despesa');
             if (despesas.length === 0) { container.style.display = 'none'; emptyState.style.display = 'flex'; return; }
             container.style.display = 'block'; emptyState.style.display = 'none';
             const ctx = document.getElementById('grafico-categorias').getContext('2d');
             const dadosAgrupados = despesas.reduce((acc, t) => { acc[t.fonte] = (acc[t.fonte] || 0) + t.valor; return acc; }, {});
             const top10 = Object.entries(dadosAgrupados).sort(([,a],[,b]) => b-a).slice(0,10);
             graficoCategorias = new Chart(ctx, { type: 'bar', data: { labels: top10.map(([f]) => f), datasets: [{ data: top10.map(([,v]) => v), backgroundColor: 'rgba(239, 68, 68, 0.7)' }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        }

        // --- EVENT LISTENERS DO DASHBOARD ---
        document.getElementById('btn-refresh').addEventListener('click', carregarDadosIniciais);
        document.getElementById('btn-toggle-theme').addEventListener('click', () => { const tema = document.body.classList.toggle('dark-mode'); localStorage.setItem('temaDashboard', tema ? 'dark' : 'light'); });
        document.getElementById('filtro-tipo').addEventListener('click', (e) => { if(e.target.tagName === 'BUTTON') { document.querySelectorAll('#filtro-tipo .btn-filtro').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); aplicarFiltros(); } });
        document.getElementById('filtro-periodo').addEventListener('click', (e) => { if(e.target.tagName === 'BUTTON') { document.querySelectorAll('#filtro-periodo .btn-filtro').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); document.getElementById('data-inicio').value = ''; document.getElementById('data-fim').value = ''; aplicarFiltros(); } });
        document.getElementById('btn-aplicar-filtro-data').addEventListener('click', () => { if(document.getElementById('data-inicio').value && document.getElementById('data-fim').value) { document.querySelectorAll('#filtro-periodo .btn-filtro').forEach(b => b.classList.remove('active')); aplicarFiltros(); } else { showToast('Selecione data de início e fim.', 'error'); } });
        
        // Modais
        function abrirModalRegistro(tipo, id = null) {
            const modal = document.getElementById('modal-registro');
            const form = document.getElementById('form-registro');
            form.reset();
            document.getElementById('reg-id').value = id || '';
            document.getElementById('reg-tipo').value = tipo;
            popularDatalist(document.getElementById('datalist-locais'), locais);
            const transacao = id ? transacoesGeral.find(t => t.id === id) : null;
            if(transacao) {
                document.getElementById('reg-data').value = transacao.data;
                document.getElementById('reg-local').value = transacao.local;
                document.getElementById('reg-fonte').value = transacao.fonte;
                document.getElementById('reg-valor').value = (transacao.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                document.getElementById('reg-status').value = transacao.status;
            } else {
                document.getElementById('reg-data').valueAsDate = new Date();
            }
            const btnSalvar = document.getElementById('btn-salvar-registro');
            if(tipo === 'Receita') {
                document.getElementById('modal-registro-titulo').textContent = 'Nova Receita';
                popularDatalist(document.getElementById('datalist-fontes'), fontesReceita);
                document.getElementById('grupo-status').style.display = 'none';
                btnSalvar.className = 'btn btn-verde';
            } else {
                document.getElementById('modal-registro-titulo').textContent = 'Nova Despesa';
                popularDatalist(document.getElementById('datalist-fontes'), fontesDespesa);
                document.getElementById('grupo-status').style.display = 'flex';
                btnSalvar.className = 'btn btn-vermelho';
            }
            modal.style.display = 'flex';
        }
        
        document.getElementById('btn-abrir-modal-receita').addEventListener('click', () => abrirModalRegistro('Receita'));
        document.getElementById('btn-abrir-modal-despesa').addEventListener('click', () => abrirModalRegistro('Despesa'));
        document.getElementById('btn-cancelar-registro').addEventListener('click', () => document.getElementById('modal-registro').style.display = 'none');
        document.getElementById('btn-fechar-registro').addEventListener('click', () => document.getElementById('modal-registro').style.display = 'none');
        document.getElementById('form-registro').addEventListener('submit', (e) => {
            e.preventDefault();
            const valor = parseFloat(document.getElementById('reg-valor').value.replace(/\./g, '').replace(',', '.'));
            if(isNaN(valor)) { showToast('Valor inválido.', 'error'); return; }
            const dados = {
                data: document.getElementById('reg-data').value,
                tipo: document.getElementById('reg-tipo').value,
                valor: valor,
                fonte: document.getElementById('reg-fonte').value,
                local: document.getElementById('reg-local').value,
                status: document.getElementById('reg-tipo').value === 'Despesa' ? document.getElementById('reg-status').value : 'Pago'
            };
            submeterDados(dados, document.getElementById('reg-id').value);
        });

        // Ações na tabela
        document.body.addEventListener('click', function(e) {
             const editBtn = e.target.closest('.btn-edit');
             if(editBtn) {
                 abrirModalRegistro(transacoesGeral.find(t => t.id === editBtn.dataset.id).tipo, editBtn.dataset.id);
             }
             const deleteBtn = e.target.closest('.btn-delete');
             if(deleteBtn && confirm('Tem certeza que deseja excluir esta transação?')) {
                 excluirTransacao(deleteBtn.dataset.id);
             }
             const pagoBtn = e.target.closest('.btn-marcar-pago');
             if(pagoBtn && confirm('Marcar esta conta como paga?')) {
                 submeterDados({ status: 'Pago' }, pagoBtn.dataset.id);
             }
        });
        
        // --- LÓGICA DA ANÁLISE COM IA (GEMINI) ---
        const modalAnaliseIA = document.getElementById('modal-analise-ia');
        document.getElementById('btn-analise-ia').addEventListener('click', async () => {
            if (transacoesFiltradas.length === 0) { showToast('Não há dados para analisar.', 'error'); return; }
            modalAnaliseIA.style.display = 'flex';
            const conteudoDiv = document.getElementById('conteudo-analise-ia');
            conteudoDiv.innerHTML = '<p><i class="fa-solid fa-spinner fa-spin"></i> Analisando suas finanças...</p>';
            
            const dadosFormatados = transacoesFiltradas.map(t => `- ${t.tipo}: ${t.fonte} (${formatarMoeda(t.valor)}) em ${formatarData(t.Data)}`).join('\n');
            const prompt = `Você é um consultor financeiro. Analise a lista de transações e forneça um resumo em português com: Balanço Geral, Principais Despesas, Sugestão de Economia e um Ponto Positivo para encorajar o usuário. Use Markdown.\n\nDados:\n${dadosFormatados}`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error(`Erro na API: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Não foi possível obter uma resposta.";
                conteudoDiv.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
            } catch (error) {
                conteudoDiv.innerHTML = `Ocorreu um erro: ${error.message}`;
            }
        });
        document.getElementById('btn-fechar-analise-ia').addEventListener('click', () => modalAnaliseIA.style.display = 'none');


        // --- INICIALIZAÇÃO DO DASHBOARD ---
        const temaSalvo = localStorage.getItem('temaDashboard');
        if (temaSalvo === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('btn-toggle-theme').innerHTML = '<i class="fa-solid fa-sun"></i>';
        }
        carregarDadosIniciais();
    }
});

function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
    toast.innerHTML = `<i class="fa-solid ${icon}"></i> ${message}`;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}
</script>
</body>
</html>

