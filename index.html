<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro Pessoal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --cor-fundo: #f0f2f5; --cor-texto: #363f5f; --cor-texto-leve: #969cb3; --cor-card: #ffffff;
            --cor-borda: #e2e8f0; --cor-verde: #10b981; --cor-vermelho: #ef4444; --cor-azul: #3b82f6;
            --sombra-card: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --transicao: all 0.3s ease-in-out;
        }
        body.dark-mode {
            --cor-fundo: #1a202c; --cor-texto: #e2e8f0; --cor-texto-leve: #a0aec0; --cor-card: #2d3748;
            --cor-borda: #4a5568;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--cor-fundo); color: var(--cor-texto); margin: 0; padding: 0; transition: var(--transicao); }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        .full-page-center { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%); }
        body.dark-mode .full-page-center { background: linear-gradient(135deg, #2c3e50 0%, #4b6cb7 100%); }
        .auth-card { background-color: var(--cor-card); padding: 40px; border-radius: 12px; box-shadow: var(--sombra-card); width: 100%; max-width: 420px; text-align: center; }
        .auth-card h2 { margin-top: 0; margin-bottom: 10px; font-size: 1.8em; }
        .auth-card .subtitle { color: var(--cor-texto-leve); margin-bottom: 30px; }
        .btn { padding: 12px 20px; border-radius: 8px; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transicao); font-weight: 500; border: none; cursor: pointer; }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .btn:hover:not(:disabled) { filter: brightness(1.1); transform: translateY(-2px); }
        .btn-azul { background-color: var(--cor-azul); color: white; }
        .modal-content { background-color: var(--cor-card); padding: 30px; border-radius: 12px; width: 100%; max-width: 600px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: scaleUp 0.3s ease; max-height: 90vh; display: flex; flex-direction: column; }
        .form-grupo { display: flex; flex-direction: column; gap: 5px; text-align: left; }
        .form-grupo label { font-weight: 500; font-size: 0.9em; color: var(--cor-texto-leve); }
        .modal-content input, .modal-content select { padding: 12px; border: 1px solid var(--cor-borda); border-radius: 8px; font-size: 1em; background-color: var(--cor-fundo); color: var(--cor-texto); transition: var(--transicao); font-family: 'Poppins', sans-serif; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 20px; border-radius: 8px; color: white; font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease-out; min-width: 250px; }
        .toast.success { background-color: var(--cor-verde); }
        .toast.error { background-color: var(--cor-vermelho); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <div id="app-container">
        <!-- TELA DE AUTENTICAÇÃO -->
        <div id="auth-container" class="full-page-center">
            <div class="auth-card">
                <i class="fa-solid fa-piggy-bank" style="font-size: 3em; color: var(--cor-azul); margin-bottom: 10px;"></i>
                <h2 id="auth-title">Bem-vindo!</h2>
                <p id="auth-subtitle" class="subtitle">Acesse o seu dashboard financeiro.</p>
                
                <form id="form-login" style="display: block;">
                    <div class="form-grupo"><label for="login-email">Email</label><input type="email" id="login-email" required autocomplete="email"></div>
                    <div class="form-grupo"><label for="login-password">Senha</label><input type="password" id="login-password" required autocomplete="current-password"></div>
                    <div class="form-botoes" style="margin-top:20px;"><button type="submit" class="btn btn-azul" style="width: 100%;">Entrar</button></div>
                    <div class="toggle-link" style="margin-top:20px;">Não tem uma conta? <a id="toggle-to-signup">Cadastre-se</a></div>
                </form>

                <form id="form-signup" style="display: none;">
                    <div class="form-grupo"><label for="signup-email">Email</label><input type="email" id="signup-email" required autocomplete="email"></div>
                    <div class="form-grupo"><label for="signup-password">Senha</label><input type="password" id="signup-password" required autocomplete="new-password"></div>
                    <div class="form-botoes" style="margin-top:20px;"><button type="submit" class="btn btn-azul" style="width: 100%;">Criar Conta</button></div>
                    <div class="toggle-link" style="margin-top:20px;">Já tem uma conta? <a id="toggle-to-login">Entrar</a></div>
                </form>
            </div>
        </div>

        <!-- DASHBOARD (Oculto por padrão) -->
        <div id="dashboard-container" class="container" style="display: none;">
            <header>
                 <div class="header-title"><h1>Meu Dashboard</h1></div>
                 <div class="header-actions">
                    <button class="btn" id="btn-logout" style="background-color: var(--cor-texto-leve);"><i class="fa-solid fa-right-from-bracket"></i> Sair</button>
                 </div>
            </header>
            <main id="main-content">
                 <!-- O conteúdo dinâmico do dashboard será inserido aqui -->
            </main>
        </div>
    </div>
    
    <!-- Seus Modais (registro, detalhes, etc.) permanecem aqui -->
    
<script>
    // --- CONFIGURAÇÕES ---
    const SUPABASE_URL = 'https://qldxyvyrafiiqfgxytab.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFsZHh5dnlyYWZpaXFmZ3h5dGFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NTc2MzksImV4cCI6MjA3MTUzMzYzOX0.x6rFKkfJjgkBLVA8tc5FESxM0KwzrkQRG-8qox0HqM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // const GEMINI_API_KEY = "SUA_CHAVE_GEMINI_AQUI"; // Descomente e insira se for usar Gemini

    document.addEventListener('DOMContentLoaded', function() {
        'use strict';
        
        const authContainer = document.getElementById('auth-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        let currentUser = null; // Armazena os dados do utilizador logado

        // --- FUNÇÃO DE HASHING DE SENHA (SEGURANÇA) ---
        // Usa a API nativa do navegador para criar um hash SHA-256 seguro.
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- LÓGICA DE AUTENTICAÇÃO CUSTOMIZADA ---
        const formLogin = document.getElementById('form-login');
        const formSignup = document.getElementById('form-signup');

        document.getElementById('toggle-to-signup').addEventListener('click', () => { formLogin.style.display = 'none'; formSignup.style.display = 'block'; document.getElementById('auth-title').textContent = 'Crie a sua Conta'; document.getElementById('auth-subtitle').textContent = 'Comece a organizar as suas finanças.'; });
        document.getElementById('toggle-to-login').addEventListener('click', () => { formSignup.style.display = 'none'; formLogin.style.display = 'block'; document.getElementById('auth-title').textContent = 'Bem-vindo!'; document.getElementById('auth-subtitle').textContent = 'Acesse o seu dashboard financeiro.'; });

        formSignup.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> A criar...';

            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            // 1. Verificar se o e-mail já existe
            const { data: existingUser, error: checkError } = await supabase.from('usuarios').select('id').eq('email', email).single();
            if (existingUser) {
                showToast('Este e-mail já está em uso.', 'error');
                btn.disabled = false; btn.innerHTML = 'Criar Conta';
                return;
            }

            // 2. Criptografar a senha
            const password_hash = await hashPassword(password);

            // 3. Inserir o novo utilizador na tabela `usuarios`
            const { error: insertError } = await supabase.from('usuarios').insert([{ email, password_hash }]);
            
            if (insertError) {
                showToast(`Erro ao criar conta: ${insertError.message}`, 'error');
            } else {
                showToast('Conta criada com sucesso! Por favor, faça o login.', 'success');
                document.getElementById('toggle-to-login').click(); // Mudar para a tela de login
            }
            btn.disabled = false; btn.innerHTML = 'Criar Conta';
        });

        formLogin.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> A entrar...';

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            // 1. Procurar o utilizador pelo e-mail
            const { data: user, error } = await supabase.from('usuarios').select('*').eq('email', email).single();

            if (error || !user) {
                showToast('E-mail ou senha inválidos.', 'error');
                btn.disabled = false; btn.innerHTML = 'Entrar';
                return;
            }

            // 2. Criptografar a senha inserida para comparar com a do banco
            const inputHash = await hashPassword(password);

            // 3. Comparar os hashes
            if (inputHash === user.password_hash) {
                // SUCESSO!
                showToast('Login bem-sucedido!', 'success');
                currentUser = user; // Guarda os dados do utilizador na sessão
                sessionStorage.setItem('dashboardUser', JSON.stringify(user)); // Guarda no sessionStorage para persistir
                authContainer.style.display = 'none';
                dashboardContainer.style.display = 'block';
                iniciarDashboard(currentUser);
            } else {
                // FALHA!
                showToast('E-mail ou senha inválidos.', 'error');
                btn.disabled = false; btn.innerHTML = 'Entrar';
            }
        });
        
        document.getElementById('btn-logout').addEventListener('click', () => {
            currentUser = null;
            sessionStorage.removeItem('dashboardUser');
            window.location.reload();
        });

        // --- VERIFICAÇÃO DE SESSÃO AO CARREGAR A PÁGINA ---
        const savedUser = sessionStorage.getItem('dashboardUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            authContainer.style.display = 'none';
            dashboardContainer.style.display = 'block';
            iniciarDashboard(currentUser);
        }

        // --- FUNÇÃO PRINCIPAL DO DASHBOARD ---
        function iniciarDashboard(user) {
            // Cole aqui a lógica completa do seu dashboard (cards, gráficos, modais, etc.)
            // As funções `carregarDadosIniciais` e `submeterDados` devem ser adaptadas
            // para usar `user.id` em todas as queries, como mostrado abaixo.
            
            // Exemplo da estrutura:
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `<h1>Dashboard do Utilizador: ${user.email}</h1><p>ID: ${user.id}</p>`; // Placeholder
            
            async function carregarDadosIniciais() {
                try {
                    const { data, error } = await supabase.from('transacoes').select('*').eq('user_id', user.id);
                    if (error) throw error;
                    console.log('Transações carregadas:', data);
                    // Aqui entra a sua lógica para renderizar os dados...
                } catch (e) {
                    showToast(`Falha ao carregar dados: ${e.message}`, 'error');
                }
            }

            async function submeterDados(dados, id = null) {
                try {
                    // Adiciona sempre o user_id aos dados a serem guardados
                    const dadosParaSalvar = { ...dados, user_id: user.id };
                    if (id) {
                        const { error } = await supabase.from('transacoes').update(dadosParaSalvar).eq('id', id);
                        if (error) throw error;
                    } else {
                        const { error } = await supabase.from('transacoes').insert([dadosParaSalvar]);
                        if (error) throw error;
                    }
                    carregarDadosIniciais();
                } catch (e) {
                     showToast(`Erro ao salvar: ${e.message}`, 'error');
                }
            }

            carregarDadosIniciais();
        }
    });

    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        const icon = type === 'success' ? 'fa-solid fa-check-circle' : 'fa-solid fa-times-circle';
        toast.innerHTML = `<i class="fa-solid ${icon}"></i> ${message}`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }
</script>

</body>
</html>

